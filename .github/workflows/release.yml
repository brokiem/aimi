name: Pre-Release

on:
  workflow_run:
    workflows: ["Build"]
    branches: ["master"]
    types:
      - completed

jobs:
  release:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      contains(github.event.workflow_run.head_commit.message, '[publish]')
    permissions:
      contents: write
    steps:
      - name: Download Android APKs
        uses: actions/download-artifact@v4
        with:
          name: aimi-android-apks
          path: artifacts/android/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Windows Build
        uses: actions/download-artifact@v4
        with:
          name: aimi-windows
          path: artifacts/windows/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Linux Build
        uses: actions/download-artifact@v4
        with:
          name: aimi-linux
          path: artifacts/linux/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: pre-${{ github.event.workflow_run.head_sha }}
          name: Pre-Release ${{ github.event.workflow_run.head_sha }}
          body: Automated pre-release for commit ${{ github.event.workflow_run.head_sha }}
          prerelease: true
          target_commitish: ${{ github.event.workflow_run.head_sha }}
          files: |
            artifacts/android/*.apk
            artifacts/windows/**/*
            artifacts/linux/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}